-- =============================================
-- ЗАДАНИЕ 1: Заказ с id 'x' с массивами услуг и материалов
-- =============================================

SELECT 
    o.order_id,
    
    ARRAY(
        SELECT jsonb_build_object(
            'название услуги', s.service_name,
            'цена', os.actual_price
        )
        FROM Order_Service os
        JOIN Service s ON os.service_id = s.service_id
        WHERE os.order_id = o.order_id
    ) as services,
    
    ARRAY(
        SELECT jsonb_build_object(
            'название материала', m.material_name,
            'количество', mu.quantity_used,
            'стоимость', ROUND((mu.quantity_used * m.price_per_unit)::numeric, 2)
        )
        FROM Material_Usage mu
        JOIN Material m ON mu.material_id = m.material_id
        WHERE mu.order_id = o.order_id
    ) as materials
    
FROM "Order" o
WHERE o.order_id = 1;  -- замените 1 на нужный ID

-- 2) Самые продаваемые материалы топ 5
SELECT 
    m.material_name,
    COUNT(mu.usage_id) as раз_использован
FROM Material m
LEFT JOIN Material_Usage mu ON m.material_id = mu.material_id
GROUP BY m.material_id, m.material_name
ORDER BY раз_использован DESC
LIMIT 5;


-- 3) Выручка со всех заказов за период
SELECT 
    EXTRACT(YEAR FROM order_date) as год,
    EXTRACT(MONTH FROM order_date) as месяц,
    SUM(total_amount) as выручка
FROM "Order"
WHERE order_date BETWEEN '2025-01-01' AND '2025-12-31'
  AND status = 'completed'
GROUP BY EXTRACT(YEAR FROM order_date), EXTRACT(MONTH FROM order_date)
ORDER BY EXTRACT(YEAR FROM order_date), EXTRACT(MONTH FROM order_date);
